name: Manual Branch Sync

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to merge from'
        required: true
        type: choice
        options:
          - main
          - release_beta
      target_branch:
        description: 'Target branch to merge into'
        required: true
        type: choice
        options:
          - release_beta
          - release

jobs:
  sync-branches:
    runs-on: ubuntu-latest

    steps:
      - name: Validate branch combination
        run: |
          SOURCE="${{ github.event.inputs.source_branch }}"
          TARGET="${{ github.event.inputs.target_branch }}"

          echo "Source: $SOURCE"
          echo "Target: $TARGET"

          # Validate allowed combinations
          if [[ "$SOURCE" == "main" && "$TARGET" != "release" ]]; then
            echo "‚ùå ERROR: mainline can only be merged into release_beta"
            exit 1
          fi

          if [[ "$SOURCE" == "release_beta" && "$TARGET" != "release" ]]; then
            echo "‚ùå ERROR: release_beta can only be merged into release"
            exit 1
          fi

          echo "‚úÖ Valid branch combination"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Configure the 'ours' merge driver
          git config merge.ours.driver true

      - name: Create sync branch and merge
        id: merge
        run: |
          SOURCE="${{ github.event.inputs.source_branch }}"
          TARGET="${{ github.event.inputs.target_branch }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SYNC_BRANCH="auto-sync-${SOURCE}-to-${TARGET}-${TIMESTAMP}"

          echo "sync_branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT

          # Checkout target branch
          git checkout "$TARGET"

          # Create new sync branch from target
          git checkout -b "$SYNC_BRANCH"

          # Attempt to merge source into sync branch
          echo "Attempting to merge $SOURCE into $SYNC_BRANCH (based on $TARGET)..."

          # Try merge, capture exit code
          set +e
          git merge "$SOURCE" --no-edit -m "Merge $SOURCE into $TARGET via automated sync"
          MERGE_EXIT_CODE=$?
          set -e

          if [ $MERGE_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Merge completed successfully with no conflicts"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Merge has conflicts - will push anyway for manual resolution"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT

            # Add all files including conflicts
            git add -A

            # Check if there's anything to commit
            if git diff --cached --quiet; then
              echo "No changes to commit after merge attempt"
            else
              git commit -m "Merge $SOURCE into $TARGET (with conflicts)" || true
            fi
          fi

          # Push the sync branch
          git push origin "$SYNC_BRANCH"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE="${{ github.event.inputs.source_branch }}"
          TARGET="${{ github.event.inputs.target_branch }}"
          SYNC_BRANCH="${{ steps.merge.outputs.sync_branch }}"
          HAS_CONFLICTS="${{ steps.merge.outputs.has_conflicts }}"

          # Create PR body
          if [[ "$HAS_CONFLICTS" == "true" ]]; then
            PR_BODY="## ü§ñ Automated Branch Sync

          This PR was automatically created to sync \`$SOURCE\` ‚Üí \`$TARGET\`.

          ‚ö†Ô∏è  **This PR has merge conflicts that need manual resolution.**

          ### Files auto-resolved via .gitattributes (merge=ours):
          - \`build.properties\`
          - \`scripts/kubernetes-brand-adserver-deployment.sh\`
          - \`scripts/kubernetes-brand-adserver-deployment_sysmgmt.sh\`

          ### Action Required:
          Please resolve remaining conflicts using GitHub's web editor or locally.

          ---
          *Triggered by: @${{ github.actor }}*"
          else
            PR_BODY="## ü§ñ Automated Branch Sync

          This PR was automatically created to sync \`$SOURCE\` ‚Üí \`$TARGET\`.

          ‚úÖ **No conflicts detected** - ready to merge!

          ### Files auto-resolved via .gitattributes (merge=ours):
          - \`build.properties\`
          - \`scripts/kubernetes-brand-adserver-deployment.sh\`
          - \`scripts/kubernetes-brand-adserver-deployment_sysmgmt.sh\`

          ---
          *Triggered by: @${{ github.actor }}*"
          fi

          # Create the PR
          gh pr create \
            --title "üîÑ Sync $SOURCE ‚Üí $TARGET" \
            --body "$PR_BODY" \
            --base "$TARGET" \
            --head "$SYNC_BRANCH" \
            --label "auto-sync"

          echo "‚úÖ Pull request created successfully"
